

# 介绍

我们的天巡系统，是可以对圈定数据做违规巡查的系统。
目前 数据量大概是日均500w，总库存几十亿的爬虫数据库。
系统分为几个模块：
1、爬虫调度
2、数据清洗
3、数据应用
整体的数据流程：
![对天巡设计的理解-数据抓取全流程.drawio.png](images%2F%E5%AF%B9%E5%A4%A9%E5%B7%A1%E8%AE%BE%E8%AE%A1%E7%9A%84%E7%90%86%E8%A7%A3-%E6%95%B0%E6%8D%AE%E6%8A%93%E5%8F%96%E5%85%A8%E6%B5%81%E7%A8%8B.drawio.png)

# 以前遇到过的问题？
数据清洗全过程：
![天巡数据清洗流程.drawio.png](images%2F%E5%A4%A9%E5%B7%A1%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97%E6%B5%81%E7%A8%8B.drawio.png)


## 1、数据清洗过程中的数据积压

背景：我们为了降低系统之间的耦合，在送数据去清洗、送数据去过机审的过程，都是通过kafka队列异步的方式，这有可能导致爬虫数据爬完后没有被及时消费，从而积压kafka，这可能是清洗服务挂了或者有问题卡住等问题。

回答方向1、调整kafka参数，提升数据库写入性能等

略

回答方向2、简化处理流程+后置处理机制
kafka服务接受到的数据，简单做一个检查，这个检查最重要的作用是防止重复数据，比如我们做简单的md5校验，取文本前后几个关键字做MD5，不会影响到数据处理的效率，校验后，立即写到mongodb不做其他过程。

后置处理机制，对于写入成功的数据，我们再去做清洗。



## 2、NIFI

NiFi（Apache NiFi）是一个强大的开源数据集成工具，它提供了直观的图形用户界面，用于构建、管理和执行数据流。在NiFi中，你可以通过将各种处理器（processors）、连接（connections）和控制器服务（controller services）组合在一起来创建数据流，实现从数据源到目标的数据流动。对于数据清洗，NiFi提供了许多内置的处理器，也支持自定义处理器，你可以使用定制化的Python代码进行数据清洗。

以下是在NiFi中使用Python脚本进行数据清洗的一般过程：

1. **配置GetFile或其他输入处理器：** 首先，你需要配置一个输入处理器（如GetFile）来获取原始数据。设置输入路径、文件过滤器等参数，以确保NiFi能够正确地获取要处理的数据文件。
2. **添加ExecuteScript处理器：** 在NiFi中，你可以使用ExecuteScript处理器来执行自定义脚本。将该处理器添加到数据流中，并连接到输入处理器的输出端。
3. **配置ExecuteScript处理器：** 配置ExecuteScript处理器以指定使用Python脚本进行处理。选择Script Engine为Python，提供脚本路径或直接将Python代码嵌入脚本框中。
4. **编写Python脚本：** 在Python脚本中，你可以编写定制化的数据清洗逻辑。读取输入流中的数据，进行清洗、转换或过滤操作，然后将结果写回到输出流。
5. **设置输入输出参数：** 配置ExecuteScript处理器的输入和输出参数。定义输入参数，将输入数据传递给Python脚本，同时设置输出参数，以获取脚本处理后的数据。
6. **运行数据流：** 启动NiFi数据流，观察数据在处理过程中的流动。NiFi提供了监控和日志功能，帮助你跟踪和调试整个数据流程。
7. **添加其他处理器（可选）：** 根据需要，你可以在数据流中添加其他处理器，如数据存储、数据分析等，以完成更复杂的数据处理任务。

通过这样的方式，就可以在NiFi中充分利用Python脚本进行定制化的数据清洗，同时利用NiFi的图形界面和强大的处理器库来简化数据集成和流处理的任务。





我们数据清洗，一开始是定制化python代码的，非常的不灵活，后面引入了NiFi，可以通过图像配置的方式 对数据做处理。从而不用每次都写一段段代码。

NiFi的一些主要好处：

1. **可视化数据流设计：** NiFi采用直观的图形用户界面，允许用户通过拖拽和连接处理器来构建和设计数据流。这种可视化的方式使得数据流的设计和管理变得简单，降低了技术门槛，同时提高了工作效率。
2. **强大的处理器库：** NiFi提供了丰富的内置处理器库，包括用于数据提取、转换、加载（ETL）、加密、解密等的处理器。这些处理器可被直接拖拽至图形界面中，使用户能够轻松地构建复杂的数据流处理逻辑。
3. **可扩展性：** NiFi支持用户自定义处理器的开发，因此可以轻松集成已有的或者特定领域的处理器。这种可扩展性使得NiFi能够适应各种不同的数据处理需求。
4. **数据流追踪和监控：** NiFi提供了丰富的监控和日志功能，可以实时查看数据流的运行状态、性能指标和错误信息。这有助于及时发现和解决问题，提高系统的稳定性和可维护性。
5. **数据安全性：** NiFi支持对数据流进行端到端的加密，以保护数据的安全性。此外，它还提供了访问控制、身份验证和授权等安全特性，确保只有授权的用户能够访问和管理数据流。
6. **数据流的弹性处理：** NiFi支持将数据流的处理过程与物理位置解耦，允许数据在分布式环境中进行弹性处理。这使得NiFi能够适应大规模数据和高并发流处理的需求。
7. **多格式支持：** NiFi能够处理多种数据格式，包括文本、JSON、XML、Avro等。它支持在不同格式之间进行转换，使得不同系统和应用之间的数据交换更加灵活。
8. **简化数据集成：** NiFi使得数据集成变得更加简单。它可以轻松集成不同系统和数据源，通过连接不同的处理器，实现异构系统之间的数据交换和协同工作。
9. **开源社区支持：** 作为Apache软件基金会的项目，NiFi拥有强大的开源社区支持。这意味着用户可以获得广泛的技术支持、文档资源和活跃的社区讨论。